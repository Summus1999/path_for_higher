# 协议八股文

## BGP状态机

BGP状态机有6种

- Idle：BGP的初始状态。BGP进程正在等待一个启动事件。此时，BGP拒绝任何进入的连接尝试，并不主动尝试建立TCP连接。
- Connect:BGP正在等待其主动发起的TCP连接（端口179）完成建立
- Active:BGP未能成功建立其主动发起的TCP连接，
- OpenSent：TCP连接已成功建立，BGP已经发送了自己的 OPEN 消息，现在正在等待接收对等体的 OPEN 消息。
- OpenConfirm：BGP已经成功交换了 OPEN 消息（参数协商成功），并且已发送了 KEEPALIVE 消息，现在正在等待接收对等体的 KEEPALIVE 或 NOTIFICATION 消息。
- Established：BGP对等体会话的最终、稳定工作状态。

## 为什么需要MP_BGP扩展？

MP-BGP（Multi-Protocol Border Gateway Protocol）的扩展需求源于传统BGP-4协议在应对现代网络多样化协议支持时的固有局限性。MP-BGP的扩展本质是重构BGP报文结构，使其从IPv4单播的封闭框架升级为通用多协议路由分发平台。

- BGP-4设计之初仅能处理IPv4单播路由信息，其报文中的关键字段（如NLRI、NEXT_HOP、AGGREGATOR）均绑定IPv4格式。IPv6、组播、VPN等协议需跨（AS）传播，但BGP-4无法承载这些协议的路由信息。
- 通过MP_REACH_NLRI携带IPv6路由的下一跳地址，实现IPv6跨AS路由传播。实现组播路由分离。
- 实现二三层VPN扩展，并增强网络扩展性与效率。
  
## 没有引入MP BGP之前支持哪几种协议？

RFC4271传统BGP4协议在没有引入MP BGP之前仅仅支持IPV4单播路由和IPV4组播路由。

## BGP的作用？

BGP（边界网关协议）的核心作用是作为互联网的“路由协议”，负责在不同自治系统之间交换网络可达性信息，实现全球互联网的互联互通。

- 在AS之间交换路由信息
- 建立和维护跨域路径
- 实现基于策略的路由控制：配置策略影响路由
- 提供可靠的路由传输：使用179端口建立TCP连接，保证路由更新可靠到达
- 支持大规模网络的可扩展性

## BGP是否产生路由？如何产生路由？

BGP协议产生路由主要有2类途径：

- 本地注入：本地注入又分为network手动配置和路由重分发，network配置即把一条精确的路由手动配置到路由表内，路由重分发则是通过其他的路由协议，如OSPF等计算出的路由**导入**到BGP进程中。
- 从BGP邻居学习：这是BGP从外部获取路由的方式，BGP和其他的peer之间通信，接收update报文然后学习到路由。

## BGP路由源是什么？

BGP的origin字段的取值一共有3个选项：

- 1：代表IGP，该路由是通过BGP的 network 命令 从路由器的本地IP路由表中精确匹配注入的
- 2：代表EGP，该路由是通过EGP协议（Exterior Gateway Protocol）学习到的。现已经被淘汰。
- 3：Incomplete，该路由是通过路由重分发（Redistribution） 方式引入BGP的。

## network报文和BGP协议引入路由的报文的区别

- network报文是本地配置的，作用于路由器本身，优先级高，不产生网络报文，需要精准配置
- update报文是BGP对等体之间传输路由信息的协议报文，作用于路由器之间，优先级低，是标准的BGP报文，报文内带有路由信息。

## update报文里面的属性有哪几类，公认必遵属性有哪些？

BGP的路由属性分为四类：公认必遵、公认自决、可选传递、可选非传递
公认必遵属性有：

- origin
- AS PATH
- next hop

## free ARP和ARP的区别？

- free arp是为了消除IP冲突或者检测IP冲突所用的一种报文，报文的源目的IP都是填的本端的IP地址，如果收到arp reply报文则证明存在IP冲突。
- arp报文是为了搞清楚IP地址和mac地址之间的映射关系而使用的一种报文，本端发送ARP request报文，目标mac地址是填的全F，目标ip地址是正常IP地址，收到ARP REPLY报文后将报文的ip和mac地址填到ARP表项中。

## QUIC协议解决了TCP的什么问题？QUIC协议的特性？

TCP协议当前存在的问题：

- TCP队头阻塞，停等问题
- 握手延迟无法避免
- 网络中间设备僵化
- 协议僵化：TCP是在操作系统内核和中间设备固件中实现的，更新协议困难，难以大规模实现。

QUIC协议的特性：
简单来说，QUIC协议就是基于UDP重新实现了一遍HTTP2的特性。
用一个等式来描述就是 QUIC = UDP + TLS + HTTP2

- 0RTT快速连接
- 连接迁移：QUIC连接是以客户端产生的一个64位随机数作为连接标识。当网络、端口发生改变或中断时，只要连接标识不改变，连接就不会中断。
- 改进拥塞控制：QUIC在应用层即可实现不同的拥塞控制算法，不需要改操作系统和内核。
- 双级别流控：TCP通过滑动窗口机制来保证可靠性以及进行流量控制。QUIC更新了其滑动窗口机制，并在Connection和Stream两个级别分别进行流控。
- 没有队头阻塞的多路复用
